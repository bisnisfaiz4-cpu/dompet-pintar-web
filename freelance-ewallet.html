<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance e-Wallet - Dompet Pintar</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .table-responsive { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; }
        .main-table th, .main-table td { padding: 12px 15px; font-size: 13px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-grid.full { grid-template-columns: 1fr; }
        .filter-area { display: flex; gap: 10px; align-items: center; background: #F8FAFC; padding: 5px 10px; border-radius: 10px; border: 1px solid var(--border-color); }
        .filter-area input[type="month"] { border: none; background: transparent; outline: none; font-family: 'Poppins'; font-weight: 500; color: var(--text-dark); cursor: pointer; }
        
        .view-section { display: none; opacity: 0; transition: opacity 0.4s ease; }
        .view-section.active { display: block; opacity: 1; animation: fadeIn 0.4s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .cell-ceklis { cursor: pointer; text-align: center; font-size: 22px; transition: 0.2s; user-select: none; }
        .cell-ceklis:hover { background-color: #F3F4F6; transform: scale(1.1); }
        .btn-switch { background: linear-gradient(135deg, #1E293B, #334155); color: white; border: none; padding: 8px 16px; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; box-shadow: 0 4px 10px rgba(30, 41, 59, 0.2); }
        .btn-switch:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(30, 41, 59, 0.3); }
        .sync-box { background: #F0FDF4; border: 1px dashed #16A34A; padding: 15px; border-radius: 12px; margin-top: 15px; }

        .modal-box { max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { flex-shrink: 0; }
        .modal-form { overflow-y: auto; overflow-x: hidden; padding-right: 5px; }
        .modal-form::-webkit-scrollbar { width: 6px; }
        .modal-form::-webkit-scrollbar-track { background: transparent; }
        .modal-form::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; gap: 10px; }
            .table-header-flex { flex-direction: column; align-items: flex-start; gap: 15px; }
            .table-header-flex > div { width: 100%; display: flex; flex-direction: column; gap: 10px; }
            .btn-switch, .btn-outline-sm, .btn-add { width: 100%; justify-content: center; padding: 10px; }
            .filter-area { width: 100%; justify-content: space-between; }
        }
        
        .platform-badge { padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 11px; }
        .plat-dana { background: #DBEAFE; color: #1D4ED8; }
        .plat-gopay { background: #D1FAE5; color: #047857; }
        .plat-ovo { background: #EDE9FE; color: #6D28D9; }
        .plat-doku { background: #FEE2E2; color: #B91C1C; }
        .plat-lainnya { background: #F1F5F9; color: #475569; }
    </style>
</head>
<body class="dashboard-body">
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-logo"><i class='bx bxs-wallet-alt'></i> Dompet Pintar</div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class='bx bxs-dashboard'></i> Dashboard</a></li>
                <li><a href="transaksi.html"><i class='bx bx-list-ul'></i> Transaksi</a></li>
                <li><a href="layanan.html"><i class='bx bx-grid-alt'></i> Layanan Digital</a></li>
                <li><a href="freelance-shopee.html"><i class='bx bx-store-alt'></i> Freelance Shopee</a></li>
                <li><a href="top-up-ewallet.html"><i class='bx bx-wallet'></i> Top Up e-Wallet</a></li>
                <li><a href="tarik-tunai.html"><i class='bx bx-money-withdraw'></i> Tarik Tunai</a></li>
                <li><a href="pulsa-data.html"><i class='bx bx-mobile-alt'></i> Pulsa & Data</a></li>
                <li><a href="listrik-tagihan.html"><i class='bx bx-bulb'></i> Listrik & Tagihan</a></li>
                <li><a href="top-up-bank.html"><i class='bx bxs-bank'></i> Top Up Bank</a></li>
                <li class="active"><a href="freelance-ewallet.html"><i class='bx bx-briefcase-alt-2'></i> Freelance e-Wallet</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="index.html" class="btn-logout" id="logoutBtn"><i class='bx bx-log-out'></i> Keluar</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <h2>Operasional: Freelance e-Wallet</h2>
                <div class="topbar-right">
                    <div class="profile-menu">
                        <img src="https://ui-avatars.com/api/?name=Admin&background=0D6EFD&color=fff" class="profile-pic">
                        <div class="profile-info">
                            <span class="name">Halo, <strong>Admin!</strong></span>
                            <span class="role">Administrator <i class='bx bx-chevron-down'></i></span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="section-card">
                    <div class="table-header-flex">
                        <div class="header-title"><h3 id="mainTitle">Data Freelance e-Wallet</h3></div>
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <button class="btn-switch" id="btnToggleView" onclick="toggleView()">
                                <i class='bx bx-grid'></i> <span>Buka Data Akun</span>
                            </button>
                        </div>
                    </div>

                    <div id="viewTransaksi" class="view-section active">
                        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; justify-content: flex-end;">
                            <div class="filter-area">
                                <i class='bx bx-filter-alt' style="color: var(--text-muted);"></i>
                                <input type="month" id="filterBulan" title="Pilih Bulan">
                                <button class="btn-icon" onclick="resetFilter()" title="Reset Filter" style="padding: 4px; color: #DC3545;"><i class='bx bx-x-circle'></i></button>
                            </div>
                            <button class="btn-outline-sm" onclick="downloadCSVFEW()" style="background: var(--card-bg); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <i class='bx bx-download'></i> Laporan
                            </button>
                            <button class="btn-add" id="btnTambahFEW"><i class='bx bx-plus'></i> Tambah Data</button>
                        </div>

                        <div class="table-responsive">
                            <table class="main-table" id="tableFEW">
                                <thead>
                                    <tr>
                                        <th>Tanggal</th><th>Device</th><th>Nomor</th><th>Platform</th><th>Via</th><th>Keterangan</th>
                                        <th style="text-align: right;">H. Normal</th><th style="text-align: right;">Diskon</th>
                                        <th style="text-align: right;">Cashback</th><th style="text-align: right;">Modal</th>
                                        <th style="text-align: right; color: #8B5CF6;">TFB</th>
                                        <th style="text-align: right; color: #0D6EFD;">Laba</th><th style="text-align: center;">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody><tr><td colspan="13" style="text-align:center; padding: 20px;"><i class='bx bx-loader-alt bx-spin'></i> Memuat data...</td></tr></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="viewAkun" class="view-section">
                        <div style="display: flex; gap: 12px; margin-bottom: 20px; justify-content: flex-end;">
                            <button class="btn-add" id="btnTambahAkun" onclick="bukaModalAkun()" style="background: #10B981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);">
                                <i class='bx bx-user-plus'></i> Tambah Akun Manual
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="main-table" id="tableAkun">
                                <thead id="theadAkun"><tr><th><i class='bx bx-loader-alt bx-spin'></i> Memuat kolom...</th></tr></thead>
                                <tbody id="tbodyAkun"></tbody>
                            </table>
                            <p style="font-size: 12px; color: var(--text-muted); margin-top: 10px;"><i class='bx bx-info-circle'></i> Matrix ini saling terhubung dengan modul Freelance Shopee.</p>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalFEW">
        <div class="modal-box" style="max-width: 650px; width: 95%;">
            <div class="modal-header">
                <h3 id="modalTitleFEW">Tambah Data Operasional e-Wallet</h3>
                <button class="close-btn" onclick="document.getElementById('modalFEW').classList.remove('show')"><i class='bx bx-x'></i></button>
            </div>
            <form id="formFEW" class="modal-form">
                <div class="form-grid full"><div class="input-wrapper"><i class='bx bx-calendar'></i><input type="date" id="fewTanggal" required></div></div>
                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bx-devices'></i><input type="text" id="fewDevice" placeholder="Device (Cth: XIAOMI)" required></div>
                    <div class="input-wrapper"><i class='bx bx-phone'></i><input type="text" id="fewNomor" placeholder="Nomor / ID" required></div>
                </div>
                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bxs-wallet'></i>
                        <select id="fewPlatform" required>
                            <option value="" disabled selected>Pilih Platform</option>
                            <option value="DANA">DANA</option>
                            <option value="GOPAY">GOPAY</option>
                            <option value="OVO">OVO</option>
                            <option value="DOKU">DOKU</option>
                            <option value="LAINNYA">LAINNYA</option>
                        </select>
                    </div>
                    <div class="input-wrapper"><i class='bx bx-link'></i>
                        <select id="fewVia" required>
                            <option value="" disabled selected>Pilih Jalur (Via)</option>
                            <option value="APK">APK</option><option value="LINK">LINK</option><option value="QRIS">QRIS</option><option value="LAINNYA">LAINNYA</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid full"><div class="input-wrapper"><i class='bx bx-note'></i><input type="text" id="fewKeterangan" placeholder="Keterangan / Promo" required></div></div>
                
                <div class="sync-box">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <p style="font-size: 13px; color: #15803D; font-weight: 600; margin: 0;"><i class='bx bx-sync'></i> Sinkronisasi Tracking Akun</p>
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; color: #15803D; font-weight: 500;">
                            <input type="checkbox" id="fewSyncCheck" onchange="toggleSyncMenu()"> Aktifkan
                        </label>
                    </div>
                    <div id="syncMenu" style="display: none; margin-top: 10px;">
                        <div class="input-wrapper">
                            <i class='bx bx-check-square'></i>
                            <select id="fewSyncKolom" style="background: white;">
                                <option value="" disabled selected>Memuat daftar aplikasi matriks...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px dashed #E2E8F0; margin: 15px 0;">
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px; font-weight: 500;">Rincian Keuangan (Rp)</p>
                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bx-money'></i><input type="text" class="uang-input" id="fewHargaNormal" placeholder="Harga Normal"></div>
                    <div class="input-wrapper"><i class='bx bxs-discount'></i><input type="text" class="uang-input" id="fewDiskon" placeholder="Diskon (Opsional)"></div>
                </div>
                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bx-wallet'></i><input type="text" class="uang-input" id="fewCashback" placeholder="Cashback (Opsional)"></div>
                    <div class="input-wrapper"><i class='bx bx-credit-card'></i><input type="text" class="uang-input" id="fewModal" placeholder="Modal"></div>
                </div>
                <div class="form-grid full">
                    <div class="input-wrapper"><i class='bx bx-transfer'></i><input type="text" class="uang-input" id="fewNominalTfb" placeholder="Nominal TFB (Opsional)"></div>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <span style="font-weight: 700; color: #0D6EFD; font-size: 14px;">Laba Rp</span>
                        <input type="text" class="uang-input" id="fewLaba" required style="border: none; font-size: 20px; font-weight: 700; color: #0D6EFD; width: 100%; background: transparent;">
                    </div>
                    <button type="submit" class="btn-primary" id="btnSimpanFEW" style="width: auto; padding: 10px 20px; border-radius: 20px;">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="modalAkun">
        <div class="modal-box" style="max-width: 400px; width: 95%;">
            <div class="modal-header">
                <h3>Tambah Akun / Nomor Baru</h3>
                <button class="close-btn" onclick="document.getElementById('modalAkun').classList.remove('show')"><i class='bx bx-x'></i></button>
            </div>
            <form id="formAkun" class="modal-form">
                <div class="input-wrapper" style="margin-bottom: 15px;"><i class='bx bx-calendar'></i><input type="text" id="akunBulan" placeholder="Bulan (Cth: NOVEMBER)" required style="text-transform: uppercase;"></div>
                <div class="input-wrapper"><i class='bx bx-phone'></i><input type="number" id="akunNomor" placeholder="Nomor / ID Akun" required></div>
                <button type="submit" class="btn-primary" id="btnSimpanAkun" style="margin-top: 25px; border-radius: 20px;">Tambahkan Akun</button>
            </form>
        </div>
    </div>

    <script>
        // ===============================================
        // MASUKKAN URL GOOGLE APPS SCRIPT-MU DI BAWAH INI
        // ===============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzZF4IpaGixmwDwoJj2irti_FZKonwd27WI4BnQvubtVGoM_Qc55spB0KHQas3SjxiAVg/exec'; 
        
        let currentView = 'transaksi'; 
        function toggleView() {
            const vTrans = document.getElementById('viewTransaksi'); const vAkun = document.getElementById('viewAkun');
            const btn = document.getElementById('btnToggleView'); const title = document.getElementById('mainTitle');
            if (currentView === 'transaksi') {
                vTrans.classList.remove('active'); setTimeout(() => { vAkun.classList.add('active'); }, 400);
                btn.innerHTML = "<i class='bx bx-list-ul'></i> <span>Kembali ke Transaksi</span>"; btn.style.background = "linear-gradient(135deg, #0D6EFD, #2563EB)";
                title.innerText = "Tracking Status Akun"; currentView = 'akun';
            } else {
                vAkun.classList.remove('active'); setTimeout(() => { vTrans.classList.add('active'); }, 400);
                btn.innerHTML = "<i class='bx bx-grid'></i> <span>Buka Data Akun</span>"; btn.style.background = "linear-gradient(135deg, #1E293B, #334155)";
                title.innerText = "Data Freelance e-Wallet"; currentView = 'transaksi';
            }
        }

        window.dataFEW = []; window.currentEditIdFEW = null;
        window.dataAkun = []; window.kolomDinamis = [];

        function formatRibuanUI(angka) { if(!angka) return ""; return angka.toString().replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
        function cleanNumber(val) { if(!val) return 0; return parseInt(val.toString().replace(/\./g, '')) || 0; }
        const formatRp = (angka) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(angka || 0);
        document.querySelectorAll('.uang-input').forEach(input => { input.addEventListener('input', function(e) { this.value = formatRibuanUI(this.value); }); });

        function fetchDataFEW() {
            fetch(API_URL + "?sheetName=Freelance_Ewallet").then(res => res.json()).then(result => {
                if (result.status === 'success') { 
                    window.dataFEW = result.data.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal)); 
                    renderTableFEW(window.dataFEW); 
                } else {
                    document.querySelector('#tableFEW tbody').innerHTML = '<tr><td colspan="13" style="text-align:center;">Tidak ada data.</td></tr>';
                }
            });
        }

        function renderTableFEW(dataToRender) { 
            const tbody = document.querySelector('#tableFEW tbody'); tbody.innerHTML = '';
            if(dataToRender.length === 0) { tbody.innerHTML = '<tr><td colspan="13" style="text-align:center;">Tidak ada data.</td></tr>'; return; }
            dataToRender.forEach(item => {
                let badgeClass = 'plat-lainnya';
                if(item.Platform === 'DANA') badgeClass = 'plat-dana';
                if(item.Platform === 'GOPAY') badgeClass = 'plat-gopay';
                if(item.Platform === 'OVO') badgeClass = 'plat-ovo';
                if(item.Platform === 'DOKU') badgeClass = 'plat-doku';

                tbody.innerHTML += `<tr>
                    <td>${item.Tanggal}</td><td>${item.Device}</td><td><strong>${item.Nomor}</strong></td>
                    <td><span class="platform-badge ${badgeClass}">${item.Platform}</span></td>
                    <td>${item.Via}</td><td>${item.Keterangan}</td>
                    <td style="text-align: right;">${formatRp(item['Harga Normal'])}</td><td style="text-align: right; color: #DC3545;">${formatRp(item.Diskon)}</td>
                    <td style="text-align: right; color: #16A34A;">${formatRp(item.Cashback)}</td><td style="text-align: right;">${formatRp(item.Modal)}</td>
                    <td style="text-align: right; color: #8B5CF6; font-weight: 500;">${formatRp(item['Nominal TFB'])}</td>
                    <td style="text-align: right; font-weight: 700; color: #0D6EFD;">${formatRp(item.Laba)}</td>
                    <td style="text-align: center;"><div style="display:flex; gap:5px; justify-content:center;">
                        <button class="btn-icon edit" onclick="editDataFEW('${item.ID}')"><i class='bx bx-pencil'></i></button>
                        <button class="btn-icon delete" onclick="hapusDataFEW('${item.ID}')"><i class='bx bx-trash'></i></button>
                    </div></td></tr>`;
            });
        }

        document.getElementById('filterBulan').addEventListener('change', function() {
            const val = this.value; renderTableFEW(val ? window.dataFEW.filter(i => i.Tanggal && i.Tanggal.startsWith(val)) : window.dataFEW);
        });
        window.resetFilter = () => { document.getElementById('filterBulan').value = ''; renderTableFEW(window.dataFEW); }

        function fetchDataAkun() {
            fetch(API_URL + "?sheetName=Tracking_Ewallet").then(res => res.json()).then(result => {
                if (result.status === 'success' && result.data.length > 0) {
                    window.dataAkun = result.data;
                    const semuaKolom = Object.keys(result.data[0]);
                    window.kolomDinamis = semuaKolom.filter(k => k !== 'ID' && k !== 'Bulan' && k !== 'Nomor');
                    renderTableAkun();
                    
                    const syncSelect = document.getElementById('fewSyncKolom');
                    syncSelect.innerHTML = '<option value="" disabled selected>Pilih Kolom Aplikasi...</option>';
                    window.kolomDinamis.forEach(kolom => { syncSelect.innerHTML += `<option value="${kolom}">${kolom}</option>`; });
                } else {
                    // KODE BARU: Jika Sheet Kosong atau Tidak Ditemukan, matikan loading!
                    document.getElementById('theadAkun').innerHTML = "<tr><th>Bulan</th><th>Nomor</th><th>Aksi</th></tr>";
                    document.getElementById('tbodyAkun').innerHTML = "<tr><td colspan='3' style='text-align:center; padding:20px; color:var(--text-muted);'>Belum ada data matriks. Pastikan ada 1 baris data di Excel, atau klik Tambah Akun Manual.</td></tr>";
                }
            }).catch(err => {
                document.getElementById('tbodyAkun').innerHTML = "<tr><td colspan='3' style='text-align:center; color:red;'>Gagal terhubung ke API. Pastikan sudah Deploy Versi Baru!</td></tr>";
            });
        }

        function renderTableAkun() {
            const thead = document.getElementById('theadAkun'); const tbody = document.getElementById('tbodyAkun');
            let headerHTML = `<tr><th style="min-width: 100px;">Bulan</th><th style="min-width: 150px;">Nomor Akun</th>`;
            window.kolomDinamis.forEach(kolom => { headerHTML += `<th style="text-align:center; background:#1E293B; color:white; min-width: 90px; border-right: 1px solid #334155;">${kolom}</th>`; });
            headerHTML += `<th style="text-align:center;">Hapus</th></tr>`; thead.innerHTML = headerHTML;

            tbody.innerHTML = '';
            window.dataAkun.forEach(item => {
                let rowHTML = `<tr><td><strong>${item.Bulan}</strong></td><td style="font-family: monospace; font-size:14px; color:#0A58CA;">${item.Nomor}</td>`;
                window.kolomDinamis.forEach(kolom => {
                    const isChecked = item[kolom] === "✅";
                    const icon = isChecked ? "<i class='bx bxs-check-square' style='color:#10B981;'></i>" : "<i class='bx bx-square' style='color:#CBD5E1;'></i>";
                    rowHTML += `<td class="cell-ceklis" onclick="toggleCeklis('${item.ID}', '${kolom}')">${icon}</td>`;
                });
                rowHTML += `<td style="text-align:center;"><button class="btn-icon delete" onclick="hapusAkun('${item.ID}')"><i class='bx bx-trash'></i></button></td></tr>`;
                tbody.innerHTML += rowHTML;
            });
        }

        window.toggleCeklis = function(id, namaKolom) {
            const item = window.dataAkun.find(x => x.ID === id); if(!item) return;
            item[namaKolom] = item[namaKolom] === "✅" ? "" : "✅"; renderTableAkun(); 
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ sheetName: "Tracking_Akun", action: "update", id: id, data: item }) });
        }

        window.toggleSyncMenu = function() { document.getElementById('syncMenu').style.display = document.getElementById('fewSyncCheck').checked ? 'block' : 'none'; }
        
        document.getElementById('btnTambahFEW').onclick = () => { 
            window.currentEditIdFEW = null; document.getElementById('modalTitleFEW').innerText = "Tambah Data Operasional e-Wallet";
            document.getElementById('formFEW').reset(); toggleSyncMenu(); document.getElementById('modalFEW').classList.add('show'); 
        };

        function getNamaBulan(tanggalString) {
            const dateObj = new Date(tanggalString);
            const bulanArr = ['JANUARI','FEBRUARI','MARET','APRIL','MEI','JUNI','JULI','AGUSTUS','SEPTEMBER','OKTOBER','NOVEMBER','DESEMBER'];
            return bulanArr[dateObj.getMonth()];
        }

        document.getElementById('formFEW').onsubmit = (e) => {
            e.preventDefault(); const btn = document.getElementById('btnSimpanFEW'); btn.innerHTML = "Memproses..."; btn.disabled = true;
            
            const tanggal = document.getElementById('fewTanggal').value;
            const nomor = document.getElementById('fewNomor').value;
            const isSync = document.getElementById('fewSyncCheck').checked;
            const syncKolom = document.getElementById('fewSyncKolom').value;

            const payload = { sheetName: "Freelance_Ewallet", action: window.currentEditIdFEW ? "update" : "create",
                tanggal: tanggal, device: document.getElementById('fewDevice').value.toUpperCase(),
                nomor: nomor, platform: document.getElementById('fewPlatform').value.toUpperCase(),
                via: document.getElementById('fewVia').value, keterangan: document.getElementById('fewKeterangan').value.toUpperCase(),
                harga_normal: cleanNumber(document.getElementById('fewHargaNormal').value), diskon: cleanNumber(document.getElementById('fewDiskon').value) || 0,
                cashback: cleanNumber(document.getElementById('fewCashback').value) || 0, modal: cleanNumber(document.getElementById('fewModal').value),
                nominal_tfb: cleanNumber(document.getElementById('fewNominalTfb').value) || 0, laba: cleanNumber(document.getElementById('fewLaba').value)
            };
            if(window.currentEditIdFEW) payload.id = window.currentEditIdFEW;

            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r=>r.json()).then(() => {
                if (isSync && syncKolom && nomor) {
                    btn.innerHTML = "Menyinkronkan Akun...";
                    const namaBulan = getNamaBulan(tanggal).toUpperCase();
                    let akunExisting = window.dataAkun.find(a => String(a.Nomor).trim() === String(nomor).trim() && String(a.Bulan).toUpperCase() === namaBulan);
                    let payloadAkun;

                    if (akunExisting) {
                        akunExisting[syncKolom] = "✅"; 
                        payloadAkun = { sheetName: "Tracking_Akun", action: "update", id: akunExisting.ID, data: akunExisting };
                    } else {
                        let newData = { Bulan: namaBulan, Nomor: String(nomor).trim() }; newData[syncKolom] = "✅";
                        payloadAkun = { sheetName: "Tracking_Akun", action: "create", data: newData };
                    }
                    fetch(API_URL, { method: 'POST', body: JSON.stringify(payloadAkun) }).then(() => selesaiSimpan());
                } else { selesaiSimpan(); }
            });

            function selesaiSimpan() {
                document.getElementById('modalFEW').classList.remove('show');
                fetchDataFEW(); fetchDataAkun(); 
                btn.innerHTML = "Simpan"; btn.disabled = false;
            }
        };

        window.editDataFEW = function(id) {
            const item = window.dataFEW.find(x => x.ID === id); 
            if (!item) { alert("Data tidak ditemukan!"); return; }

            window.currentEditIdFEW = id; document.getElementById('modalTitleFEW').innerText = "Edit Data Operasional";
            
            document.getElementById('fewTanggal').value = item['Tanggal'] || '';
            document.getElementById('fewDevice').value = item['Device'] || '';
            document.getElementById('fewNomor').value = item['Nomor'] || '';
            document.getElementById('fewPlatform').value = item['Platform'] || '';
            document.getElementById('fewVia').value = item['Via'] || '';
            document.getElementById('fewKeterangan').value = item['Keterangan'] || '';
            
            ['Harga Normal','Diskon','Cashback','Modal','Nominal TFB','Laba'].forEach(k => {
                let inputId = 'few' + k.replace(' ','').replace('TFB','Tfb');
                if(document.getElementById(inputId)) document.getElementById(inputId).value = formatRibuanUI(item[k]);
            });
            
            document.getElementById('fewSyncCheck').checked = false; toggleSyncMenu();
            document.getElementById('modalFEW').classList.add('show');
        }

        window.hapusDataFEW = (id) => { if(confirm("Hapus transaksi ini?")) fetch(API_URL, { method: 'POST', body: JSON.stringify({ sheetName: "Freelance_Ewallet", action: "delete", id: id }) }).then(()=>fetchDataFEW()); }

        window.downloadCSVFEW = function() {
            if (!window.dataFEW || window.dataFEW.length === 0) { alert("Belum ada data!"); return; }
            let csvContent = "ID,Tanggal,Device,Nomor,Platform,Via,Keterangan,Harga Normal,Diskon,Cashback,Modal,Nominal TFB,Laba\n";
            window.dataFEW.forEach(row => {
                let ket = `"${(row.Keterangan || "").replace(/"/g, '""')}"`;
                csvContent += `${row.ID},${row.Tanggal},${row.Device},${row.Nomor},${row.Platform},${row.Via},${ket},${row['Harga Normal']},${row.Diskon},${row.Cashback},${row.Modal},${row['Nominal TFB']},${row.Laba}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            link.download = "Laporan_Freelance_eWallet.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        window.bukaModalAkun = () => { document.getElementById('formAkun').reset(); document.getElementById('modalAkun').classList.add('show'); }
        document.getElementById('formAkun').onsubmit = (e) => {
            e.preventDefault(); const btn = document.getElementById('btnSimpanAkun'); btn.innerHTML = "Memproses..."; btn.disabled = true;
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ sheetName: "Tracking_Akun", action: "create", data: { Bulan: document.getElementById('akunBulan').value.toUpperCase(), Nomor: document.getElementById('akunNomor').value } }) })
            .then(r => r.json()).then(res => { document.getElementById('modalAkun').classList.remove('show'); fetchDataAkun(); }).finally(() => { btn.innerHTML = "Tambahkan Akun"; btn.disabled = false; });
        }
        window.hapusAkun = (id) => { if(confirm("Hapus baris akun ini?")) fetch(API_URL, { method: 'POST', body: JSON.stringify({ sheetName: "Tracking_Akun", action: "delete", id: id }) }).then(()=>fetchDataAkun()); }

        fetchDataFEW(); fetchDataAkun();
    </script>
</body>
</html>