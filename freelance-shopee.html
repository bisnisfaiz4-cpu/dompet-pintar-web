<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance Shopee - Dompet Pintar</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .table-responsive { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; }
        .main-table th, .main-table td { padding: 12px 15px; font-size: 13px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-grid.full { grid-template-columns: 1fr; }
        
        /* Gaya khusus untuk area Filter */
        .filter-area { display: flex; gap: 10px; align-items: center; background: #F8FAFC; padding: 5px 10px; border-radius: 10px; border: 1px solid var(--border-color); }
        .filter-area input[type="month"] { border: none; background: transparent; outline: none; font-family: 'Poppins'; font-weight: 500; color: var(--text-dark); cursor: pointer; }
    </style>
</head>
<body class="dashboard-body">
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-logo"><i class='bx bxs-wallet-alt'></i> Dompet Pintar</div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class='bx bxs-dashboard'></i> Dashboard</a></li>
                <li><a href="transaksi.html"><i class='bx bx-list-ul'></i> Transaksi</a></li>
                <li><a href="layanan.html"><i class='bx bx-grid-alt'></i> Layanan Digital</a></li>
                <li class="active"><a href="freelance-shopee.html"><i class='bx bx-store-alt'></i> Freelance Shopee</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="index.html" class="btn-logout" id="logoutBtn"><i class='bx bx-log-out'></i> Keluar</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <h2>Operasional: Freelance Shopee</h2>
                <div class="topbar-right">
                    <div class="profile-menu">
                        <img src="https://ui-avatars.com/api/?name=Admin&background=0D6EFD&color=fff" class="profile-pic">
                        <div class="profile-info">
                            <span class="name">Halo, <strong>Admin!</strong></span>
                            <span class="role">Administrator <i class='bx bx-chevron-down'></i></span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="section-card">
                    
                    <div class="table-header-flex">
                        <div class="header-title">
                            <h3>Data Top Up & Freelance</h3>
                        </div>
                        
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            
                            <div class="filter-area">
                                <i class='bx bx-filter-alt' style="color: var(--text-muted);"></i>
                                <input type="month" id="filterBulan" title="Pilih Bulan">
                                <button class="btn-icon" onclick="resetFilter()" title="Reset Filter" style="padding: 4px; color: #DC3545;"><i class='bx bx-x-circle'></i></button>
                            </div>

                            <button class="btn-outline-sm" onclick="downloadCSVFreelance()" style="background: var(--card-bg); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <i class='bx bx-download'></i> Laporan
                            </button>
                            
                            <button class="btn-add" id="btnTambahFS">
                                <i class='bx bx-plus'></i> Tambah Data
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="main-table" id="tableFS">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Device</th>
                                    <th>Nomor</th>
                                    <th>APK</th>
                                    <th>Via</th>
                                    <th>Keterangan</th>
                                    <th style="text-align: right;">H. Normal</th>
                                    <th style="text-align: right;">Diskon</th>
                                    <th style="text-align: right;">Cashback</th>
                                    <th style="text-align: right;">Modal</th>
                                    <th style="text-align: right; color: #0D6EFD;">Laba</th>
                                    <th style="text-align: center;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="12" style="text-align:center; padding: 20px;"><i class='bx bx-loader-alt bx-spin'></i> Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalFS">
        <div class="modal-box" style="max-width: 650px;">
            <div class="modal-header">
                <h3 id="modalTitleFS">Tambah Data Operasional</h3>
                <button class="close-btn" id="closeModalFS"><i class='bx bx-x'></i></button>
            </div>
            <form id="formFS" class="modal-form">
                
                <div class="form-grid full">
                    <div class="input-wrapper"><i class='bx bx-calendar'></i><input type="date" id="fsTanggal" required></div>
                </div>

                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bx-devices'></i><input type="text" id="fsDevice" placeholder="Device (Cth: XIAOMI REDMI)" required></div>
                    <div class="input-wrapper"><i class='bx bx-phone'></i><input type="text" id="fsNomor" placeholder="Nomor / ID" required></div>
                </div>

                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bxl-android'></i><input type="text" id="fsApk" placeholder="APK (Cth: SHOPEEPAY)" required></div>
                    <div class="input-wrapper"><i class='bx bx-link'></i>
                        <select id="fsVia" required>
                            <option value="" disabled selected>Pilih Jalur (Via)</option>
                            <option value="APK">APK</option>
                            <option value="LINK">LINK</option>
                            <option value="QRIS">QRIS</option>
                            <option value="LAINNYA">LAINNYA</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid full">
                    <div class="input-wrapper"><i class='bx bx-note'></i><input type="text" id="fsKeterangan" placeholder="Keterangan (Cth: KLIK INDOMARET)" required></div>
                </div>

                <hr style="border: 0; border-top: 1px dashed #E2E8F0; margin: 15px 0;">
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px; font-weight: 500;">Rincian Keuangan (Rp)</p>

                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bx-money'></i><input type="text" class="uang-input" id="fsHargaNormal" inputmode="numeric" placeholder="Harga Normal"></div>
                    <div class="input-wrapper"><i class='bx bxs-discount'></i><input type="text" class="uang-input" id="fsDiskon" inputmode="numeric" placeholder="Diskon (Jika Ada)"></div>
                </div>

                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bx-wallet'></i><input type="text" class="uang-input" id="fsCashback" inputmode="numeric" placeholder="Cashback"></div>
                    <div class="input-wrapper"><i class='bx bx-credit-card'></i><input type="text" class="uang-input" id="fsModal" inputmode="numeric" placeholder="Modal"></div>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <span style="font-weight: 700; color: #0D6EFD; font-size: 14px;">Laba Bersih Rp</span>
                        <input type="text" class="uang-input" id="fsLaba" inputmode="numeric" placeholder="0" required style="border: none; font-size: 20px; font-weight: 700; color: #0D6EFD; width: 100%; background: transparent;">
                    </div>
                    <button type="submit" class="btn-primary" id="btnSimpanFS" style="width: auto; padding: 10px 30px; border-radius: 20px;">Simpan Data</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===============================================
        // MASUKKAN URL GOOGLE APPS SCRIPT-MU DI SINI !!!
        // ===============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzZF4IpaGixmwDwoJj2irti_FZKonwd27WI4BnQvubtVGoM_Qc55spB0KHQas3SjxiAVg/exec'; 
        
        window.dataFreelance = []; 
        window.currentEditIdFS = null; // Menyimpan ID saat mode Edit

        const formatRp = (angka) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(angka || 0);
        
        // Pemisah titik otomatis untuk form
        function formatRibuanUI(angka) {
            if(!angka) return "";
            return angka.toString().replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        document.querySelectorAll('.uang-input').forEach(input => {
            input.addEventListener('input', function(e) { this.value = formatRibuanUI(this.value); });
        });

        function cleanNumber(val) {
            if(!val) return 0;
            return parseInt(val.toString().replace(/\./g, '')) || 0;
        }

        // AMBIL DATA & RENDER TABEL
        function fetchDataFreelance() {
            fetch(API_URL + "?sheetName=Freelance_Shopee")
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    window.dataFreelance = result.data.reverse(); // Simpan dan balik urutan
                    renderTableFS(window.dataFreelance);
                } else {
                    document.querySelector('#tableFS tbody').innerHTML = '<tr><td colspan="12" style="text-align:center;">Belum ada data.</td></tr>';
                }
            });
        }

        function renderTableFS(dataToRender) {
            const tbody = document.querySelector('#tableFS tbody');
            tbody.innerHTML = '';
            
            if(dataToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:20px; color:var(--text-muted);">Tidak ada data pada periode ini.</td></tr>';
                return;
            }

            dataToRender.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.Tanggal}</td>
                        <td>${item.Device}</td>
                        <td><strong>${item.Nomor}</strong></td>
                        <td><span class="status-badge" style="background:#EBF4FF; color:#0A58CA;">${item.APK}</span></td>
                        <td>${item.Via}</td>
                        <td>${item.Keterangan}</td>
                        <td style="text-align: right;">${formatRp(item['Harga Normal'])}</td>
                        <td style="text-align: right; color: #DC3545;">${formatRp(item.Diskon)}</td>
                        <td style="text-align: right; color: #16A34A;">${formatRp(item.Cashback)}</td>
                        <td style="text-align: right;">${formatRp(item.Modal)}</td>
                        <td style="text-align: right; font-weight: 700; color: #0D6EFD;">${formatRp(item.Laba)}</td>
                        <td style="text-align: center;">
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <button class="btn-icon edit" onclick="editDataFS('${item.ID}')" title="Edit"><i class='bx bx-pencil'></i></button>
                                <button class="btn-icon delete" onclick="hapusDataFS('${item.ID}')" title="Hapus"><i class='bx bx-trash'></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // ===============================================
        // FITUR BARU 1: FILTER BULAN
        // ===============================================
        const filterInput = document.getElementById('filterBulan');
        filterInput.addEventListener('change', function() {
            const selectedMonth = this.value; // Formatnya "YYYY-MM", misal: "2026-02"
            if(!selectedMonth) { renderTableFS(window.dataFreelance); return; }

            const filteredData = window.dataFreelance.filter(item => {
                // Mengecek apakah string tanggal (YYYY-MM-DD) berawalan YYYY-MM pilihan user
                return item.Tanggal && item.Tanggal.startsWith(selectedMonth);
            });
            renderTableFS(filteredData);
        });

        window.resetFilter = function() {
            document.getElementById('filterBulan').value = '';
            renderTableFS(window.dataFreelance);
        }

        // ===============================================
        // FITUR BARU 2: EDIT & SIMPAN DATA
        // ===============================================
        const modal = document.getElementById('modalFS');
        document.getElementById('btnTambahFS').onclick = () => { 
            window.currentEditIdFS = null; 
            document.getElementById('modalTitleFS').innerText = "Tambah Data Operasional";
            document.getElementById('formFS').reset(); 
            modal.classList.add('show'); 
        };
        document.getElementById('closeModalFS').onclick = () => modal.classList.remove('show');

        // Fungsi Membuka Modal Edit
        window.editDataFS = function(id) {
            const item = window.dataFreelance.find(x => x.ID === id);
            if (!item) return;

            window.currentEditIdFS = id;
            document.getElementById('modalTitleFS').innerText = "Edit Data Operasional";
            
            // Isi semua inputan dengan data lama
            document.getElementById('fsTanggal').value = item.Tanggal;
            document.getElementById('fsDevice').value = item.Device;
            document.getElementById('fsNomor').value = item.Nomor;
            document.getElementById('fsApk').value = item.APK;
            document.getElementById('fsVia').value = item.Via;
            document.getElementById('fsKeterangan').value = item.Keterangan;
            
            // Isi form uang dan berikan pemisah titik
            document.getElementById('fsHargaNormal').value = formatRibuanUI(item['Harga Normal']);
            document.getElementById('fsDiskon').value = formatRibuanUI(item.Diskon);
            document.getElementById('fsCashback').value = formatRibuanUI(item.Cashback);
            document.getElementById('fsModal').value = formatRibuanUI(item.Modal);
            document.getElementById('fsLaba').value = formatRibuanUI(item.Laba);

            modal.classList.add('show');
        }

        // Simpan Data (Create / Update)
        document.getElementById('formFS').onsubmit = (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSimpanFS');
            btn.innerHTML = "Menyimpan..."; btn.disabled = true;

            const payload = {
                sheetName: "Freelance_Shopee", 
                tanggal: document.getElementById('fsTanggal').value,
                device: document.getElementById('fsDevice').value.toUpperCase(),
                nomor: document.getElementById('fsNomor').value,
                apk: document.getElementById('fsApk').value.toUpperCase(),
                via: document.getElementById('fsVia').value,
                keterangan: document.getElementById('fsKeterangan').value.toUpperCase(),
                harga_normal: cleanNumber(document.getElementById('fsHargaNormal').value),
                diskon: cleanNumber(document.getElementById('fsDiskon').value) || "-",
                cashback: cleanNumber(document.getElementById('fsCashback').value),
                modal: cleanNumber(document.getElementById('fsModal').value),
                laba: cleanNumber(document.getElementById('fsLaba').value)
            };

            // Jika ada ID yang sedang diedit, tambahkan perintah "update"
            if(window.currentEditIdFS) {
                payload.action = "update";
                payload.id = window.currentEditIdFS;
            } else {
                payload.action = "create";
            }

            fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(res => {
                modal.classList.remove('show');
                fetchDataFreelance(); // Reload tabel agar data segar
            })
            .finally(() => { btn.innerHTML = "Simpan Data"; btn.disabled = false; });
        };

        window.hapusDataFS = function(id) {
            if(!confirm("Yakin hapus data ini secara permanen?")) return;
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ sheetName: "Freelance_Shopee", action: "delete", id: id })
            }).then(() => fetchDataFreelance());
        }

        // DOWNLOAD CSV
        window.downloadCSVFreelance = function() {
            if (!window.dataFreelance || window.dataFreelance.length === 0) { alert("Belum ada data!"); return; }
            let csvContent = "ID,Tanggal,Device,Nomor,APK,Via,Keterangan,Harga Normal,Diskon,Cashback,Modal,Laba\n";
            window.dataFreelance.forEach(row => {
                let ket = `"${(row.Keterangan || "").replace(/"/g, '""')}"`;
                csvContent += `${row.ID},${row.Tanggal},${row.Device},${row.Nomor},${row.APK},${row.Via},${ket},${row['Harga Normal']},${row.Diskon},${row.Cashback},${row.Modal},${row.Laba}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Laporan_Shopee_Freelance.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Jalankan saat halaman dibuka
        fetchDataFreelance();
    </script>
</body>
</html>