<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listrik & Tagihan - Dompet Pintar</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .table-responsive { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; }
        .main-table th, .main-table td { padding: 12px 15px; font-size: 13px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-grid.full { grid-template-columns: 1fr; }
        .filter-area { display: flex; gap: 10px; align-items: center; background: #F8FAFC; padding: 5px 10px; border-radius: 10px; border: 1px solid var(--border-color); }
        .filter-area input[type="month"] { border: none; background: transparent; outline: none; font-family: 'Poppins'; font-weight: 500; color: var(--text-dark); cursor: pointer; }
        
        .modal-box { max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { flex-shrink: 0; }
        .modal-form { overflow-y: auto; overflow-x: hidden; padding-right: 5px; }
        .modal-form::-webkit-scrollbar { width: 6px; }
        .modal-form::-webkit-scrollbar-track { background: transparent; }
        .modal-form::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; gap: 10px; }
            .table-header-flex { flex-direction: column; align-items: flex-start; gap: 15px; }
            .table-header-flex > div { width: 100%; display: flex; flex-direction: column; gap: 10px; }
            .btn-outline-sm, .btn-add { width: 100%; justify-content: center; padding: 10px; }
            .filter-area { width: 100%; justify-content: space-between; }
        }
        
        .badge-status { padding: 5px 10px; border-radius: 6px; font-weight: 600; font-size: 11px; }
        .badge-sukses { background: #D1FAE5; color: #059669; }
        .badge-pending { background: #FEF3C7; color: #D97706; }
        .badge-gagal { background: #FEE2E2; color: #DC2626; }

        .badge-jenis { padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 11px; }
        .jenis-token { background: #FEF9C3; color: #CA8A04; border: 1px solid #FEF08A; }
        .jenis-tagihan { background: #E0F2FE; color: #0284C7; border: 1px solid #BAE6FD; }

        .info-calc { background: #FFFBEB; border: 1px dashed #F59E0B; padding: 10px 15px; border-radius: 8px; font-size: 12px; color: #B45309; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body class="dashboard-body">
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-logo"><i class='bx bxs-wallet-alt'></i> Dompet Pintar</div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class='bx bxs-dashboard'></i> Dashboard</a></li>
                <li><a href="transaksi.html"><i class='bx bx-list-ul'></i> Transaksi</a></li>
                <li><a href="layanan.html"><i class='bx bx-grid-alt'></i> Layanan Digital</a></li>
                <li><a href="freelance-shopee.html"><i class='bx bx-store-alt'></i> Freelance Shopee</a></li>
                <li><a href="top-up-ewallet.html"><i class='bx bx-wallet'></i> Top Up e-Wallet</a></li>
                <li><a href="tarik-tunai.html"><i class='bx bx-money-withdraw'></i> Tarik Tunai</a></li>
                <li><a href="pulsa-data.html"><i class='bx bx-mobile-alt'></i> Pulsa & Data</a></li>
                <li class="active"><a href="listrik-tagihan.html"><i class='bx bx-bulb'></i> Listrik & Tagihan</a></li>
                <li><a href="top-up-bank.html"><i class='bx bxs-bank'></i> Top Up Bank</a></li>
                <li><a href="freelance-ewallet.html"><i class='bx bx-briefcase-alt-2'></i> Freelance e-Wallet</a></li>
            </ul>
            <div class="sidebar-footer">
                <a href="index.html" class="btn-logout" id="logoutBtn"><i class='bx bx-log-out'></i> Keluar</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <h2>Layanan: Listrik & Tagihan PPOB</h2>
                <div class="topbar-right">
                    <div class="profile-menu">
                        <img src="https://ui-avatars.com/api/?name=Admin&background=0D6EFD&color=fff" class="profile-pic">
                        <div class="profile-info">
                            <span class="name">Halo, <strong>Admin!</strong></span>
                            <span class="role">Administrator <i class='bx bx-chevron-down'></i></span>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="section-card">
                    <div class="table-header-flex">
                        <div class="header-title"><h3>Data Token & Bayar Tagihan</h3></div>
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; justify-content: flex-end;">
                            <div class="filter-area">
                                <i class='bx bx-filter-alt' style="color: var(--text-muted);"></i>
                                <input type="month" id="filterBulan" title="Pilih Bulan">
                                <button class="btn-icon" onclick="resetFilter()" title="Reset Filter" style="padding: 4px; color: #DC3545;"><i class='bx bx-x-circle'></i></button>
                            </div>
                            <button class="btn-outline-sm" onclick="downloadCSVPLN()" style="background: var(--card-bg); color: var(--text-dark); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                <i class='bx bx-download'></i> Laporan
                            </button>
                            <button class="btn-add" id="btnTambahPLN"><i class='bx bx-plus'></i> Tambah Data</button>
                        </div>
                    </div>

                    <div class="table-responsive" style="margin-top: 20px;">
                        <table class="main-table" id="tablePLN">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Jenis</th>
                                    <th>ID Pelanggan</th>
                                    <th>Atas Nama</th>
                                    <th style="text-align: right;">Nominal / Tagihan</th>
                                    <th style="text-align: right; color: #DC2626;">Admin Server</th>
                                    <th style="text-align: right; color: #16A34A;">Total Bayar</th>
                                    <th style="text-align: center;">Status</th>
                                    <th style="text-align: right; color: #0D6EFD;">Laba</th>
                                    <th style="text-align: center;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody><tr><td colspan="10" style="text-align:center; padding: 20px;"><i class='bx bx-loader-alt bx-spin'></i> Memuat data...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalPLN">
        <div class="modal-box" style="max-width: 650px; width: 95%;">
            <div class="modal-header">
                <h3 id="modalTitlePLN">Tambah Transaksi PPOB</h3>
                <button class="close-btn" onclick="document.getElementById('modalPLN').classList.remove('show')"><i class='bx bx-x'></i></button>
            </div>
            <form id="formPLN" class="modal-form">
                
                <div class="info-calc">
                    <i class='bx bxs-bolt' style="font-size: 18px;"></i>
                    <span><strong>Auto-Laba Listrik:</strong> Masukkan Nominal, Admin Server, dan Total Bayar Pelanggan. Laba terhitung otomatis!</span>
                </div>

                <div class="form-grid full"><div class="input-wrapper"><i class='bx bx-calendar'></i><input type="date" id="plnTanggal" required></div></div>
                
                <div class="form-grid full">
                    <div class="input-wrapper"><i class='bx bx-category'></i>
                        <select id="plnJenis" required>
                            <option value="" disabled selected>Pilih Jenis Transaksi Listrik / Tagihan</option>
                            <option value="TOKEN PRABAYAR">TOKEN PRABAYAR (ISI ULANG)</option>
                            <option value="TAGIHAN PASCABAYAR">TAGIHAN PASCABAYAR (BULANAN)</option>
                            <option value="TAGIHAN LAINNYA">TAGIHAN LAINNYA (PDAM / BPJS / INTERNET)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bx-barcode-reader'></i><input type="text" id="plnIdPelanggan" placeholder="No. Meter / ID Pelanggan" required></div>
                    <div class="input-wrapper"><i class='bx bx-id-card'></i><input type="text" id="plnAtasNama" placeholder="Atas Nama (Cth: Budi Santoso)" required></div>
                </div>
                
                <hr style="border: 0; border-top: 1px dashed #E2E8F0; margin: 15px 0;">
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px; font-weight: 500;">Rincian Harga & Pembayaran (Rp)</p>
                
                <div class="form-grid">
                    <div class="input-wrapper"><i class='bx bx-money'></i><input type="text" class="uang-input" id="plnNominal" placeholder="Nominal Token / Tagihan Asli" required></div>
                    <div class="input-wrapper"><i class='bx bx-minus-circle'></i><input type="text" class="uang-input" id="plnAdmin" placeholder="Biaya Admin Server (Bila ada)"></div>
                </div>

                <div class="form-grid full" style="margin-top: 5px;">
                    <div class="input-wrapper" style="background: #F0FDF4; border-color: #16A34A;">
                        <i class='bx bx-wallet' style="color: #16A34A;"></i>
                        <input type="text" class="uang-input" id="plnTotalBayar" placeholder="Total Bayar Pelanggan (Ke Kamu)" required style="font-weight: 600; color: #16A34A; background: transparent;">
                    </div>
                </div>
                
                <div class="form-grid full" style="margin-top: 5px;">
                    <div class="input-wrapper"><i class='bx bx-loader-circle'></i>
                        <select id="plnStatus" required>
                            <option value="SUKSES" selected>SUKSES</option>
                            <option value="PENDING">PENDING</option>
                            <option value="GAGAL">GAGAL</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                        <span style="font-weight: 700; color: #0D6EFD; font-size: 14px;">Laba Bersih Rp</span>
                        <input type="text" class="uang-input" id="plnLaba" required style="border: none; font-size: 20px; font-weight: 700; color: #0D6EFD; width: 100%; background: transparent;" placeholder="0">
                    </div>
                    <button type="submit" class="btn-primary" id="btnSimpanPLN" style="width: auto; padding: 10px 30px; border-radius: 20px;">Simpan Transaksi</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ===============================================
        // MASUKKAN URL GOOGLE APPS SCRIPT-MU DI BAWAH INI
        // ===============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzZF4IpaGixmwDwoJj2irti_FZKonwd27WI4BnQvubtVGoM_Qc55spB0KHQas3SjxiAVg/exec'; 
        
        window.dataPLN = []; window.currentEditIdPLN = null;

        function formatRibuanUI(angka) { if(!angka) return ""; return angka.toString().replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
        function cleanNumber(val) { if(!val) return 0; return parseInt(val.toString().replace(/\./g, '')) || 0; }
        const formatRp = (angka) => new Intl.NumberFormat('id-ID', { minimumFractionDigits: 0 }).format(angka || 0);
        
        document.querySelectorAll('.uang-input').forEach(input => { input.addEventListener('input', function(e) { this.value = formatRibuanUI(this.value); }); });

        // ===============================================
        // KALKULATOR LABA (Total Bayar Pelanggan - (Nominal + Admin Server))
        // ===============================================
        document.getElementById('plnNominal').addEventListener('input', hitungLabaPLN);
        document.getElementById('plnAdmin').addEventListener('input', hitungLabaPLN);
        document.getElementById('plnTotalBayar').addEventListener('input', hitungLabaPLN);

        function hitungLabaPLN() {
            let nominal = cleanNumber(document.getElementById('plnNominal').value);
            let admin = cleanNumber(document.getElementById('plnAdmin').value);
            let totalBayar = cleanNumber(document.getElementById('plnTotalBayar').value);
            
            // Modal Asli kamu adalah Nominal Tagihan + Admin Server
            let modalAsli = nominal + admin;
            let laba = totalBayar - modalAsli;
            
            document.getElementById('plnLaba').value = formatRibuanUI(laba);
        }

        // ===============================================
        // FUNGSI UTAMA (CRUD)
        // ===============================================
        function fetchDataPLN() {
            fetch(API_URL + "?sheetName=Listrik_Tagihan").then(res => res.json()).then(result => {
                if (result.status === 'success') { 
                    window.dataPLN = result.data.sort((a, b) => new Date(b.Tanggal) - new Date(a.Tanggal)); 
                    renderTablePLN(window.dataPLN); 
                } else {
                    document.querySelector('#tablePLN tbody').innerHTML = '<tr><td colspan="10" style="text-align:center;">Tidak ada data.</td></tr>';
                }
            });
        }

        function renderTablePLN(dataToRender) { 
            const tbody = document.querySelector('#tablePLN tbody'); tbody.innerHTML = '';
            if(dataToRender.length === 0) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Tidak ada data.</td></tr>'; return; }
            
            dataToRender.forEach(item => {
                let badgeStatus = 'badge-sukses';
                if(item.Status === 'PENDING') badgeStatus = 'badge-pending';
                if(item.Status === 'GAGAL') badgeStatus = 'badge-gagal';

                let badgeJenis = item.Jenis.includes('TOKEN') ? 'jenis-token' : 'jenis-tagihan';

                tbody.innerHTML += `<tr>
                    <td>${item.Tanggal}</td>
                    <td><span class="badge-jenis ${badgeJenis}">${item.Jenis}</span></td>
                    <td style="font-family: monospace; font-size: 14px;"><strong>${item['ID Pelanggan']}</strong></td>
                    <td>${item['Atas Nama']}</td>
                    <td style="text-align: right;">${formatRp(item.Nominal)}</td>
                    <td style="text-align: right; color: #DC2626;">${formatRp(item.Admin)}</td>
                    <td style="text-align: right; color: #16A34A; font-weight: 600;">${formatRp(item['Total Bayar'])}</td>
                    <td style="text-align: center;"><span class="badge-status ${badgeStatus}">${item.Status}</span></td>
                    <td style="text-align: right; font-weight: 700; color: #0D6EFD;">${formatRp(item.Laba)}</td>
                    <td style="text-align: center;"><div style="display:flex; gap:5px; justify-content:center;">
                        <button class="btn-icon edit" onclick="editDataPLN('${item.ID}')"><i class='bx bx-pencil'></i></button>
                        <button class="btn-icon delete" onclick="hapusDataPLN('${item.ID}')"><i class='bx bx-trash'></i></button>
                    </div></td></tr>`;
            });
        }

        document.getElementById('filterBulan').addEventListener('change', function() {
            const val = this.value; renderTablePLN(val ? window.dataPLN.filter(i => i.Tanggal && i.Tanggal.startsWith(val)) : window.dataPLN);
        });
        window.resetFilter = () => { document.getElementById('filterBulan').value = ''; renderTablePLN(window.dataPLN); }

        document.getElementById('btnTambahPLN').onclick = () => { 
            window.currentEditIdPLN = null; document.getElementById('modalTitlePLN').innerText = "Tambah Transaksi PPOB";
            document.getElementById('formPLN').reset(); document.getElementById('modalPLN').classList.add('show'); 
        };

        document.getElementById('formPLN').onsubmit = (e) => {
            e.preventDefault(); const btn = document.getElementById('btnSimpanPLN'); btn.innerHTML = "Memproses..."; btn.disabled = true;
            
            const payload = { 
                sheetName: "Listrik_Tagihan", action: window.currentEditIdPLN ? "update" : "create",
                tanggal: document.getElementById('plnTanggal').value, 
                jenis: document.getElementById('plnJenis').value,
                id_pelanggan: document.getElementById('plnIdPelanggan').value, 
                atas_nama: document.getElementById('plnAtasNama').value.toUpperCase(),
                nominal: cleanNumber(document.getElementById('plnNominal').value), 
                admin: cleanNumber(document.getElementById('plnAdmin').value),
                total_bayar: cleanNumber(document.getElementById('plnTotalBayar').value), 
                status_trx: document.getElementById('plnStatus').value,
                laba: cleanNumber(document.getElementById('plnLaba').value)
            };
            if(window.currentEditIdPLN) payload.id = window.currentEditIdPLN;

            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r=>r.json()).then(() => {
                document.getElementById('modalPLN').classList.remove('show');
                fetchDataPLN(); 
                btn.innerHTML = "Simpan Transaksi"; btn.disabled = false;
            });
        };

        window.editDataPLN = function(id) {
            const item = window.dataPLN.find(x => x.ID === id); 
            if (!item) { alert("Data tidak ditemukan!"); return; }

            window.currentEditIdPLN = id; document.getElementById('modalTitlePLN').innerText = "Edit Transaksi Listrik";
            
            document.getElementById('plnTanggal').value = item['Tanggal'] || '';
            document.getElementById('plnJenis').value = item['Jenis'] || '';
            document.getElementById('plnIdPelanggan').value = item['ID Pelanggan'] || '';
            document.getElementById('plnAtasNama').value = item['Atas Nama'] || '';
            document.getElementById('plnStatus').value = item['Status'] || 'SUKSES';
            
            document.getElementById('plnNominal').value = formatRibuanUI(item['Nominal']);
            document.getElementById('plnAdmin').value = formatRibuanUI(item['Admin']);
            document.getElementById('plnTotalBayar').value = formatRibuanUI(item['Total Bayar']);
            document.getElementById('plnLaba').value = formatRibuanUI(item['Laba']);
            
            document.getElementById('modalPLN').classList.add('show');
        }

        window.hapusDataPLN = (id) => { if(confirm("Hapus transaksi ini secara permanen?")) fetch(API_URL, { method: 'POST', body: JSON.stringify({ sheetName: "Listrik_Tagihan", action: "delete", id: id }) }).then(()=>fetchDataPLN()); }

        window.downloadCSVPLN = function() {
            if (!window.dataPLN || window.dataPLN.length === 0) { alert("Belum ada data!"); return; }
            let csvContent = "ID,Tanggal,Jenis,ID Pelanggan,Atas Nama,Nominal,Admin,Total Bayar,Status,Laba\n";
            window.dataPLN.forEach(row => {
                csvContent += `${row.ID},${row.Tanggal},${row.Jenis},${row['ID Pelanggan']},"${row['Atas Nama']}",${row.Nominal},${row.Admin},${row['Total Bayar']},${row.Status},${row.Laba}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            link.download = "Laporan_Listrik_Tagihan.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // Jalankan saat pertama dibuka
        fetchDataPLN();
    </script>
</body>
</html>